name: VPS NoMachine 100% DIRECTO

on:
  workflow_dispatch:

jobs
  windows-nomachine-session:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Horas
    
    steps:
      - name: "1. Habilitar Aceleración KVM"
        run: sudo chown $USER /dev/kvm

      - name: "2. Preparar Instalador Automático de NoMachine"
        run: |
          mkdir -p extras
          cd extras
          wget -q https://download.nomachine.com/download/8.11/Windows/nomachine_8.11.3_4_x86_64.exe -O nomachine.exe
          echo '@echo off' > autorun.cmd
          echo 'start /wait "" "%~dp0nomachine.exe" /S' >> autorun.cmd
          echo 'del "%~dp0nomachine.exe"' >> autorun.cmd
          echo 'del "%~f0"' >> autorun.cmd

      - name: "3. Desplegar Windows con NoMachine Integrado"
        run: |
          docker run -d \
            --name=windows \
            --device=/dev/kvm \
            --cap-add NET_ADMIN \
            -p 4000:4000/tcp \
            -v ./extras:/mnt/extras \
            -e RAM_SIZE="14G" \
            -e CPU_CORES="4" \
            -e VERSION="8.1" \
            -e ISO="https://archive.org/download/windows-8.1-lite_202502/Windows%208.1%20Lite.iso" \
            -e FLAGS="-drive file=/mnt/extras,index=2,media=cdrom" \
            ghcr.io/dockur/windows
            
          echo "Windows se está instalando y NoMachine se instalará solo."
          echo "Espera unos 5-10 minutos antes de intentar conectar."
          sleep 90

      - name: "4. Crear TÚNEL ÚNICO para NoMachine"
        run: |
          echo "---------------------------------------------------------"
          echo "CONECTA USANDO ESTA DIRECCIÓN EN EL CLIENTE NOMACHINE:"
          echo "---------------------------------------------------------"
          docker run --rm --net=host cloudflare/cloudflared:latest tunnel --url tcp://localhost:4000
